# Comprehensive Test Fixture

This directory contains PostgreSQL log fixtures generated by `test/generate/generate_fixtures.sh`.

## Files

| File | Format | Description |
|------|--------|-------------|
| `stderr.log` | stderr | PostgreSQL text log with custom prefix |
| `csvlog.csv` | CSV | PostgreSQL CSV log format |
| `jsonlog.json` | JSON | PostgreSQL JSON log format (PG15+) |
| `syslog.log` | syslog | Logs via syslog-ng |
| `expected.json` | JSON | Expected counter values for validation |

## Generation

```bash
cd test/generate
./generate_fixtures.sh
```

Requirements:
- Docker and Docker Compose
- psql client
- ~30 minutes for full generation

## Configuration

The fixture is generated with:
- PostgreSQL 17 Alpine
- `log_line_prefix = '%t [%p] %e: db=%d,user=%u,app=%a,client=%h '`
- `log_min_duration_statement = 0` (all queries logged)
- `work_mem = 1MB` (triggers temp files easily)
- Aggressive autovacuum settings

## Target Metrics

### Connections
- 25 connections, 23 disconnections
- 5 users: app_user (12), admin (5), readonly (4), batch (3), analyst (1)
- 3 databases: app_db (15), analytics (7), postgres (3)
- 6 applications: webapp, psql, pgadmin, batch_job, metabase, pg_dump

### SQL Queries
- 300 total queries, 45 unique patterns
- Distribution: SELECT (150), INSERT (50), UPDATE (40), DELETE (15), etc.
- Duration: <1ms (80), <10ms (150), <100ms (50), <1s (18), â‰¥1s (2)

### Maintenance
- 4 autovacuum, 3 autoanalyze
- 3 manual VACUUM, 3 manual ANALYZE
- 5 checkpoints (3 time-based, 2 WAL-based)

### Locks
- 8 lock waits, 6 locks acquired after waiting
- 2 deadlocks detected

### Temp Files
- 4 temp file events, ~100MB total
- 3 distinct queries causing temp files

### Events
- LOG: ~700, ERROR: 15, WARNING: 8, FATAL: 2, PANIC: 0

## Regeneration

To regenerate after changing scenarios:

```bash
cd test/generate
./generate_fixtures.sh

# Verify with quellog
quellog ../testdata/comprehensive/stderr.log --json | jq .
```

## Notes

- JSON log requires PostgreSQL 15+
- Syslog capture requires syslog-ng container
- Actual counts may vary slightly due to timing
